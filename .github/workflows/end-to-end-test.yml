name: E2E Test

# This builds all binary versions and runs the end-to-end test against test Dynatrace environments
# This currently only runs on push to main and nightly

on:
  push:
    branches: [ main ]
  schedule:
  # nightly build ensure E2E tests run daily and catch any breaking API changes
  - cron: '0 0 * * *'
  pull_request_target:
    types: [ labeled ]

defaults:
  run:
    shell: bash

env:
  E2E_TEST_LABEL: 'run-e2e-test'

jobs:
  setup:
    name: Setup variables
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Store base repo sha
      if: github.event.action == 'labeled' && github.event.label.name == env.E2E_TEST_LABEL
      run: echo "SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_STATE

    - name: Store base repo sha
      if: github.event.action != 'labeled'
      run: echo "SHA=${{ GITHUB_SHA }}" >> $GITHUB_STATE


  release-binaries:
    name: Build release binaries
    needs: [setup]
    if: (github.event.action != 'labeled' || github.event.label.name == env.E2E_TEST_LABEL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe #v4.1.0
      with:
        go-version: '~1.20'

    - name: Checkout
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1
      with:
        ref: ${{ env.SHA }}

    - name: üèÅ Build release binaries
      run: make build-release

  integration-test:
    name: Integration tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe #v4.1.0
      with:
        go-version: '~1.20'


    - name: Check out base repo
      if: github.event.action != 'labeled'
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1

    # If a PR was reviewed and deemed safe to run in the context of our repo and it's secrets, we label it to trigger E2E tests.
    # In that case this Action is triggered in pull_request_target context and checks out the HEAD of the PR branch.
    # This is a semi-secure manually reviewed way to ensure we only run code we're fine accessing our secrets
    - name: Check out PR # nosemgrep:yaml.github-actions.security.pull-request-target-code-checkout.pull-request-target-code-checkout
      if: github.event.action == 'labeled' && github.event.label.name == env.E2E_TEST_LABEL
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: üåé Integration test
      if: (github.event.action != 'labeled' || github.event.label.name == env.E2E_TEST_LABEL)
      run: make integration-test testopts="--junitfile test-result-integration.xml"
      env:
        URL_ENVIRONMENT_1: ${{ secrets.URL_ENVIRONMENT_1 }}
        URL_ENVIRONMENT_2: ${{ secrets.URL_ENVIRONMENT_2 }}
        TOKEN_ENVIRONMENT_1: ${{ secrets.TOKEN_ENVIRONMENT_1 }}
        TOKEN_ENVIRONMENT_2: ${{ secrets.TOKEN_ENVIRONMENT_2 }}
        PLATFORM_URL_ENVIRONMENT_1: ${{ secrets.PLATFORM_URL_ENVIRONMENT_1 }}
        PLATFORM_URL_ENVIRONMENT_2: ${{ secrets.PLATFORM_URL_ENVIRONMENT_2 }}
        OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
        OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        OAUTH_TOKEN_ENDPOINT: ${{ secrets.OAUTH_TOKEN_ENDPOINT }}

    - name: ‚¨ÜÔ∏è Upload Test Results
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v3.1.3
      if: always()
      with:
        name: Test Results
        path: test-result-*.xml

  legacy-integration-tests:
    name: Legacy integration tests
    if: (github.event.action != 'labeled' || github.event.label.name == env.E2E_TEST_LABEL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe #v4.1.0
      with:
        go-version: '~1.20'


    - name: Check out base repo
      if: github.event.action != 'labeled'
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1

    # If a PR was reviewed and deemed safe to run in the context of our repo and it's secrets, we label it to trigger E2E tests.
    # In that case this Action is triggered in pull_request_target context and checks out the HEAD of the PR branch.
    # This is a semi-secure manually reviewed way to ensure we only run code we're fine accessing our secrets
    - name: Check out PR # nosemgrep:yaml.github-actions.security.pull-request-target-code-checkout.pull-request-target-code-checkout
      if: github.event.action == 'labeled' && github.event.label.name == env.E2E_TEST_LABEL
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: üßì Integration test (legacy)
      run: make integration-test-v1 testopts="--junitfile test-result-integration-legacy.xml"
      env:
        URL_ENVIRONMENT_1: ${{ secrets.URL_ENVIRONMENT_1 }}
        URL_ENVIRONMENT_2: ${{ secrets.URL_ENVIRONMENT_2 }}
        TOKEN_ENVIRONMENT_1: ${{ secrets.TOKEN_ENVIRONMENT_1 }}
        TOKEN_ENVIRONMENT_2: ${{ secrets.TOKEN_ENVIRONMENT_2 }}
        PLATFORM_URL_ENVIRONMENT_1: ${{ secrets.PLATFORM_URL_ENVIRONMENT_1 }}
        PLATFORM_URL_ENVIRONMENT_2: ${{ secrets.PLATFORM_URL_ENVIRONMENT_2 }}
        OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
        OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        OAUTH_TOKEN_ENDPOINT: ${{ secrets.OAUTH_TOKEN_ENDPOINT }}

    - name: ‚¨ÜÔ∏è Upload Test Results
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v3.1.3
      if: always()
      with:
        name: Test Results
        path: test-result-*.xml


  download-restore-test:
    name: Download-restore-test
    if: (github.event.action != 'labeled' || github.event.label.name == env.E2E_TEST_LABEL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe #v4.1.0
      with:
        go-version: '~1.20'


    - name: Check out base repo
      if: github.event.action != 'labeled'
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1

    # If a PR was reviewed and deemed safe to run in the context of our repo and it's secrets, we label it to trigger E2E tests.
    # In that case this Action is triggered in pull_request_target context and checks out the HEAD of the PR branch.
    # This is a semi-secure manually reviewed way to ensure we only run code we're fine accessing our secrets
    - name: Check out PR # nosemgrep:yaml.github-actions.security.pull-request-target-code-checkout.pull-request-target-code-checkout
      if: github.event.action == 'labeled' && github.event.label.name == env.E2E_TEST_LABEL
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: üì•/üì§ Download/Restore test
      run: make download-restore-test testopts="--junitfile test-result-integration-download-restore.xml"
      env:
        URL_ENVIRONMENT_1: ${{ secrets.URL_ENVIRONMENT_1 }}
        URL_ENVIRONMENT_2: ${{ secrets.URL_ENVIRONMENT_2 }}
        TOKEN_ENVIRONMENT_1: ${{ secrets.TOKEN_ENVIRONMENT_1 }}
        TOKEN_ENVIRONMENT_2: ${{ secrets.TOKEN_ENVIRONMENT_2 }}
        PLATFORM_URL_ENVIRONMENT_1: ${{ secrets.PLATFORM_URL_ENVIRONMENT_1 }}
        PLATFORM_URL_ENVIRONMENT_2: ${{ secrets.PLATFORM_URL_ENVIRONMENT_2 }}
        OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
        OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        OAUTH_TOKEN_ENDPOINT: ${{ secrets.OAUTH_TOKEN_ENDPOINT }}

    - name: ‚¨ÜÔ∏è Upload Test Results
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v3.1.3
      if: always()
      with:
        name: Test Results
        path: test-result-*.xml


  nightly-run:
    name: Nightly test
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe #v4.1.0
      with:
        go-version: '~1.20'

    - name: Check out base repo
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1

    - name: üåô Nightly Tests
      run: make nightly-test testopts="--junitfile test-result-integration-nightly.xml"
      env:
        URL_ENVIRONMENT_1: ${{ secrets.URL_ENVIRONMENT_1 }}
        URL_ENVIRONMENT_2: ${{ secrets.URL_ENVIRONMENT_2 }}
        TOKEN_ENVIRONMENT_1: ${{ secrets.TOKEN_ENVIRONMENT_1 }}
        TOKEN_ENVIRONMENT_2: ${{ secrets.TOKEN_ENVIRONMENT_2 }}
        PLATFORM_URL_ENVIRONMENT_1: ${{ secrets.PLATFORM_URL_ENVIRONMENT_1 }}
        PLATFORM_URL_ENVIRONMENT_2: ${{ secrets.PLATFORM_URL_ENVIRONMENT_2 }}
        OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
        OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        OAUTH_TOKEN_ENDPOINT: ${{ secrets.OAUTH_TOKEN_ENDPOINT }}

    - name: üßπ Cleanup
      run: make clean-environments
      env:
        URL_ENVIRONMENT_1: ${{ secrets.URL_ENVIRONMENT_1 }}
        URL_ENVIRONMENT_2: ${{ secrets.URL_ENVIRONMENT_2 }}
        TOKEN_ENVIRONMENT_1: ${{ secrets.TOKEN_ENVIRONMENT_1 }}
        TOKEN_ENVIRONMENT_2: ${{ secrets.TOKEN_ENVIRONMENT_2 }}
        PLATFORM_URL_ENVIRONMENT_1: ${{ secrets.PLATFORM_URL_ENVIRONMENT_1 }}
        PLATFORM_URL_ENVIRONMENT_2: ${{ secrets.PLATFORM_URL_ENVIRONMENT_2 }}
        OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
        OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
        OAUTH_TOKEN_ENDPOINT: ${{ secrets.OAUTH_TOKEN_ENDPOINT }}

    - name: ‚¨ÜÔ∏è Upload Test Results
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v3.1.3
      if: always()
      with:
        name: Test Results
        path: test-result-*.xml

  upload_event:
    name: "Upload Event File"
    runs-on: ubuntu-latest
    steps:
    - name: Upload
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v3.1.3
      with:
        name: event_file
        path: ${{ github.event_path }}
